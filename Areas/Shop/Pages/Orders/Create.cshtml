@page
@model VinylShop.Areas.Shop.Pages.Orders.CreateModel
@{
    ViewData["Title"] = "–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è";
}

<link rel="stylesheet" href="~/css/order.css" />

<div class="banner-section">
    <img src="~/img/vinyl_header.jpg" alt="Vinyl Header" class="banner-image" />
</div>

<div class="order-container">
    <h1 class="order-title">–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    <div id="cart-items" class="cart-items-wrapper"></div>

    <form method="post" class="checkout-form">
        <input type="text" name="FullName" placeholder="–ü–Ü–ë" required />
        <input type="tel" name="Phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required />
        <input type="email" name="BuyerEmail" placeholder="E-mail" required />
        <input type="text" name="City" placeholder="–ú—ñ—Å—Ç–æ" required />
        <input type="text" name="Address" placeholder="–ê–¥—Ä–µ—Å–∞ | –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏" required />

        <fieldset>
            <legend>–°–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏</legend>
            <label><input type="radio" name="DeliveryMethod" value="–°–∞–º–æ–≤–∏–≤—ñ–∑" checked /> –°–∞–º–æ–≤–∏–≤—ñ–∑</label>
            <label><input type="radio" name="DeliveryMethod" value="–ü–æ –º—ñ—Å—Ç—É" /> –ü–æ –º—ñ—Å—Ç—É (–≤—ñ–¥ 299 –≥—Ä–Ω)</label>
            <label><input type="radio" name="DeliveryMethod" value="–ù–æ–≤–∞ –ü–æ—à—Ç–∞" /> –ù–æ–≤–∞ –ü–æ—à—Ç–∞</label>
        </fieldset>

        <fieldset>
            <legend>–í–∞—Ä—ñ–∞–Ω—Ç —É–ø–∞–∫–æ–≤–∫–∏</legend>
            <label><input type="radio" name="Packaging" value="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞" checked /> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∞</label>
            <label><input type="radio" name="Packaging" value="–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞" /> –ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ (–≤—ñ–¥ 399 –≥—Ä–Ω)</label>
        </fieldset>

        <textarea name="Comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"></textarea>
        <input type="text" name="PromoCode" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" />

        <fieldset>
            <legend>–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏</legend>
            <label><input type="radio" name="PaymentMethod" value="–ì–æ—Ç—ñ–≤–∫–∞" checked /> –ì–æ—Ç—ñ–≤–∫–æ–≤–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫</label>
            <label><input type="radio" name="PaymentMethod" value="–ö–∞—Ä—Ç–∞" /> –ë–µ–∑–≥–æ—Ç—ñ–≤–∫–æ–≤–∞ –æ–ø–ª–∞—Ç–∞</label>
        </fieldset>

        <div class="order-footer">
            <div class="final-total">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: <span id="final-sum">0 –≥—Ä–Ω.</span></div>
            <button type="submit" class="btn btn-success full-width">–ó–∞–º–æ–≤–∏—Ç–∏</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cartContainer = document.getElementById('cart-items');
        const totalElement = document.getElementById('final-sum');

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—à–∏–∫–∞ –∑ localStorage
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        // –õ–æ–≥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–∞–Ω–∏—Ö, —è–∫—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ localStorage
        console.log("–ö–æ—à–∏–∫ —É localStorage:", cart);

        function updateCartDisplay() {
            cartContainer.innerHTML = '';
            let totalSum = 0;

            // –û–±—Ä–æ–±–∫–∞ —Ç–æ–≤–∞—Ä—É –≤ –∫–æ—à–∏–∫—É
            cart.forEach((item, index) => {
                const subtotal = (item.qty * item.price).toFixed(2);
                totalSum += parseFloat(subtotal);

                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è HTML –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç—É –∫–æ—à–∏–∫–∞
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('cart-item');
                itemDiv.innerHTML = `
                    <img src="${itemImage}" alt="${item.title}" width="80" height="80">
                    <div class="cart-item-info">
                        <a class="cart-item-title" href="/Shop/Albums/Details/${item.id}">${item.title}</a>
                        <div class="quantity-control">
                            <button class="btn-qty minus" data-index="${index}">-</button>
                            <span class="item-qty">${item.qty}</span>
                            <button class="btn-qty plus" data-index="${index}">+</button>
                        </div>
                        <div class="cart-item-price">${subtotal} –≥—Ä–Ω.</div>
                    </div>
                    <button class="btn-remove" data-index="${index}" style="color: red; font-size: 20px; border: none; background: none;">üóëÔ∏è</button>
                `;
                cartContainer.appendChild(itemDiv);
            });

            totalElement.textContent = `${totalSum.toFixed(2)} –≥—Ä–Ω.`;
        }

        // –û–±—Ä–æ–±–∫–∞ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è/–∑–º–µ–Ω—à–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
        cartContainer.addEventListener('click', function (e) {
            if (e.target.classList.contains('btn-qty')) {
                const index = parseInt(e.target.dataset.index);
                if (e.target.classList.contains('plus')) {
                    cart[index].qty += 1;
                } else if (e.target.classList.contains('minus') && cart[index].qty > 1) {
                    cart[index].qty -= 1;
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }

            // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É –∑ –∫–æ—à–∏–∫–∞
            if (e.target.classList.contains('btn-remove')) {
                const index = parseInt(e.target.dataset.index);
                cart.splice(index, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }
        });

        if (!cart.length) {
            cartContainer.innerHTML = '<p>–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π.</p>';
            totalElement.textContent = '0 –≥—Ä–Ω.';
        } else {
            updateCartDisplay();
        }
    });
</script>

<script>
    if (window.location.pathname.includes('Create')) {
        document.querySelector('.cart-button').style.display = 'none';
    }
</script>
